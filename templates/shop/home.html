{% extends "base.html" %}
{% load i18n %}

{% block title %}
  {% if request.GET.q %}
    {{ request.GET.q }} — {% trans "поиск" %} | {% trans "MEZON Market" %}
  {% else %}
    {% trans "MEZON Market — доставка продуктов" %}
  {% endif %}
{% endblock %}

{% block meta_description %}
  {% if request.GET.q %}
    {% trans "Результаты поиска по запросу" %} «{{ request.GET.q }}». {% trans "Быстрая доставка по Фергане" %}
  {% else %}
    {% trans "Закажите свежие продукты онлайн: категории, популярные товары, удобная корзина и быстрая доставка." %}
  {% endif %}
{% endblock %}

{% block og_type %}website{% endblock %}


{% block hero %}
<div class="glass p-4 md:p-6">
  <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
    <div>
      <div class="text-2xl md:text-3xl font-extrabold leading-tight">{% trans "Магазин" %}</div>
      <div class="text-muted mt-1">{% trans "Категории и товары" %}</div>
    </div>

    <form method="get" class="flex gap-2 w-full md:w-auto">
      <input
        type="text"
        name="q"
        value="{{ q|default:'' }}"
        placeholder="{% trans 'Поиск...' %}"
        class="w-full md:w-80 px-4 py-2 rounded-2xl outline-none"
      />

      <button
        type="submit"
        class="px-5 py-2 rounded-2xl bg-sky-600 text-main hover:bg-sky-700 transition whitespace-nowrap"
      >
        {% trans "Найти" %}
      </button>
    </form>
  </div>
</div>
{% endblock %}


{% block content %}
<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
  {% for c in categories %}
    <a href="{% url 'category' c.id %}" class="glass px-4 py-3 rounded-2xl text-center hover:opacity-90">
      {{ c.name }}
    </a>
  {% endfor %}
</div>

{# ===== АКЦИИ ===== #}
{% if promo_products %}
  <div class="glass p-4 rounded-3xl mb-4">
    <div class="flex items-center justify-between gap-3">
      <div class="text-xl md:text-2xl font-extrabold">{% trans "Акции" %}</div>

      <div class="sale-badge">
        <svg class="icon-bolt" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M13 2 3 14h7l-1 8 12-14h-7l-1-6Z"/>
        </svg>
        {% trans "Скидки" %}
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
    {% for product in promo_products %}
      <div class="glass p-4 rounded-3xl">
        <a href="{% url 'product' product.id %}" class="block">
          {% if product.image %}
            <img src="{{ product.image.url }}" class="w-full h-44 object-cover rounded-2xl" alt="{{ product.name }}">
          {% else %}
            <div class="w-full h-44 rounded-2xl bg-white/5"></div>
          {% endif %}

          <div class="mt-3 flex items-center justify-between gap-2">
            <div class="font-bold text-lg leading-snug line-clamp-2">
              {{ product.name }}
            </div>

            <span class="sale-badge shrink-0">
              <svg class="icon-bolt" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13 2 3 14h7l-1 8 12-14h-7l-1-6Z"/>
              </svg>
              {% trans "Акция" %}
            </span>
          </div>
        </a>

        <div class="mt-1 text-muted text-sm line-clamp-2">{{ product.description }}</div>

        <div class="mt-3 flex items-end justify-between gap-3">
          <div>
            {% if product.old_price %}
              <div class="price-old">{{ product.old_price }}</div>
            {% endif %}
            <div class="price-new">{{ product.price }}</div>
          </div>

          {% if product.stock|default:0 > 0 %}
            <div class="text-xs text-muted">{% trans "В наличии" %}: {{ product.stock }}</div>
          {% else %}
            <div class="text-xs text-muted">{% trans "Нет в наличии" %}</div>
          {% endif %}
        </div>

        <div class="mt-4">
          {% if product.stock|default:0 > 0 %}
            <button
              type="button"
              class="btn-brand w-full py-3 rounded-2xl"
              data-add-to-cart
              data-url="{% url 'add_to_cart' product.id %}"
              data-name="{{ product.name|escapejs }}"
            >
              {% trans "В корзину" %}
            </button>
          {% else %}
            <button
              type="button"
              class="w-full py-3 rounded-2xl bg-white/10 text-white/50 cursor-not-allowed"
              disabled
            >
              {% trans "Нет в наличии" %}
            </button>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}


{# ===== ОСТАЛЬНЫЕ ТОВАРЫ ===== #}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
  {% for product in products %}
    <div class="glass p-4 rounded-3xl">
      <a href="{% url 'product' product.id %}" class="block">
      {% if product.image %}
        <img src="{{ product.image.url }}" class="w-full h-44 object-cover rounded-2xl" alt="{{ product.name }}">
      {% else %}
        <div class="w-full h-44 rounded-2xl bg-white/5"></div>
      {% endif %}

      <!-- НАЗВАНИЕ ТОВАРА -->
      <div class="mt-3 text-base font-semibold text-main leading-snug line-clamp-2">
      {{ product.name }}
      </div>

    </a>


      <div class="mt-1 text-muted text-sm line-clamp-2">{{ product.description }}</div>

      <div class="mt-3 flex items-center justify-between">
        <div class="text-xl font-extrabold">{{ product.price }}</div>
        {% if product.stock|default:0 > 0 %}
          <div class="text-xs text-white/60">{% trans "В наличии" %}: {{ product.stock }}</div>
        {% else %}
          <div class="text-xs text-white/60">{% trans "Нет в наличии" %}</div>
        {% endif %}
      </div>

      <div class="mt-4">
        {% if product.stock|default:0 > 0 %}
          <button
            type="button"
            class="btn-brand w-full text-center py-3 rounded-2xl text-base md:text-sm active:scale-[0.99] transition"
            data-add-to-cart
            data-url="{% url 'add_to_cart' product.id %}"
            data-name="{{ product.name|escapejs }}"
          >
            {% trans "В корзину" %}
          </button>
        {% else %}
          <button
            type="button"
            class="w-full text-center py-3 rounded-2xl text-base md:text-sm bg-white/10 text-white/50 cursor-not-allowed"
            disabled
          >
            {% trans "Нет в наличии" %}
          </button>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <div class="glass p-6 rounded-3xl text-muted">
      {% trans "Ничего не найдено." %}
    </div>
  {% endfor %}
</div>
{% endblock %}
