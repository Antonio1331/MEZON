{% extends "base.html" %}
{% load i18n %}

{% block title %}
  {{ category.name }} — {% trans "Категория" %} | MEZON Market
{% endblock %}

{% block content %}

<!-- Баннер категории -->
<div class="glass rounded-3xl overflow-hidden mb-6">
  {% if category.image %}
    <img src="{{ category.image.url }}" alt="{{ category.name }}"
         class="w-full h-44 md:h-52 object-cover">
  {% else %}
    <div class="w-full h-44 md:h-52 bg-white/10"></div>
  {% endif %}

  <div class="p-4 md:p-6">
    <h1 class="text-2xl md:text-3xl font-extrabold">{{ category.name }}</h1>
    <p class="text-white/70 text-sm md:text-base mt-1">
      {% trans "Выберите товары и добавьте их в корзину" %}
    </p>
    <a href="{% url 'home' %}" class="inline-block mt-3 badge-soft px-4 py-2 rounded-xl text-sm">
      ← {% trans "На главную" %}
    </a>
  </div>
</div>

<!-- Поиск -->
<form method="get" class="mb-6">
  <input type="text" name="q" value="{{ request.GET.q }}"
         placeholder="{% trans 'Поиск в категории...' %}"
         class="w-full rounded-2xl px-4 py-3 bg-white/10 border border-white/20 focus:outline-none focus:border-blue-400 transition">
</form>

<!-- Акции -->
{% if promo_products %}
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl md:text-2xl font-extrabold">{% trans "Акции" %}</h2>
    <span class="bg-red-600/80 text-white px-3 py-1 rounded-full text-sm font-medium">⚡ {% trans "Скидки" %}</span>
  </div>

  <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
    {% for product in promo_products %}
      {% include "shop/partials/product_card.html" with is_promo=True %}
    {% endfor %}
  </div>
{% endif %}

<!-- Все товары категории -->
<h2 class="text-xl md:text-2xl font-extrabold mb-4">{% trans "Товары" %}</h2>

<div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
  {% for product in products %}
    {% include "shop/partials/product_card.html" %}
  {% empty %}
    <div class="glass p-6 rounded-3xl text-white/70 col-span-2 md:col-span-3 lg:col-span-4 text-center">
      {% trans "В этой категории пока нет товаров." %}
    </div>
  {% endfor %}
</div>

<!-- JavaScript для AJAX-добавления в корзину и toast-уведомлений -->
<script>
// Функция показа уведомления (toast)
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-6 right-6 z-50 px-6 py-4 rounded-xl shadow-2xl text-white font-medium flex items-center gap-3 transform transition-all duration-500 translate-y-20 opacity-0`;
  toast.innerHTML = `
    ${type === 'success' ? '✅' : '⚠️'} ${message}
  `;

  if (type === 'success') {
    toast.classList.add('bg-gradient-to-r', 'from-green-600', 'to-emerald-600');
  } else {
    toast.classList.add('bg-red-600');
  }

  document.body.appendChild(toast);

  // Появление
  setTimeout(() => {
    toast.classList.remove('translate-y-20', 'opacity-0');
    toast.classList.add('translate-y-0', 'opacity-100');
  }, 100);

  // Исчезновение через 3 секунды
  setTimeout(() => {
    toast.classList.add('translate-y-20', 'opacity-0');
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-add-to-cart]').forEach(btn => {
    btn.addEventListener('click', async function() {
      if (this.disabled) return;

      const productId = this.dataset.productId;
      const productName = this.dataset.productName || 'Товар';
      const originalHTML = this.innerHTML;

      // Визуальный отклик
      this.innerHTML = '<span class="animate-pulse">Добавляем...</span>';
      this.disabled = true;

      try {
        const response = await fetch("{% url 'add_to_cart' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            product_id: productId,
            quantity: 1
          })
        });

        const data = await response.json();

        if (data.success) {
          showToast(`${productName} добавлен в корзину!`, 'success');
        } else {
          showToast(data.message || 'Не удалось добавить товар', 'error');
        }
      } catch (err) {
        console.error(err);
        showToast('Ошибка при добавлении в корзину', 'error');
      } finally {
        this.innerHTML = originalHTML;
        this.disabled = false;
      }
    });
  });
});
</script>

{% endblock %}