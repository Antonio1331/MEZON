{% load static i18n %}
<!doctype html>
<html lang="{{ LANGUAGE_CODE|default:'uz' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  {# ===== SEO BASIC ===== #}
  <title>{% block title %}{% trans "MEZON Market" %}{% endblock %}</title>
  <meta name="description"
        content="{% block meta_description %}{% trans '–°–≤–µ–∂–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Ä—è–¥–æ–º. –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –∏ —É–¥–æ–±–Ω—ã–π –∑–∞–∫–∞–∑.' %}{% endblock %}">
  <link rel="canonical" href="https://mezon-market.uz{{ request.path }}">

  {# ===== OPEN GRAPH ===== #}
  <meta property="og:site_name" content="{% trans 'MEZON Market' %}">
  <meta property="og:title" content="{% block og_title %}{% trans 'MEZON Market' %}{% endblock %}">
  <meta property="og:description" content="{% block og_description %}{% trans '–°–≤–µ–∂–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Ä—è–¥–æ–º. –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –∏ —É–¥–æ–±–Ω—ã–π –∑–∞–∫–∞–∑.' %}{% endblock %}">
  <meta property="og:url" content="https://mezon-market.uz{{ request.path }}">
  <meta property="og:type" content="{% block og_type %}website{% endblock %}">
  <meta property="og:image" content="{% block og_image %}https://mezon-market.uz{% static 'img/logo.jpg' %}{% endblock %}">

  {# ===== TWITTER ===== #}
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{% block tw_title %}{% trans 'MEZON Market' %}{% endblock %}">
  <meta name="twitter:description" content="{% block tw_description %}{% trans '–°–≤–µ–∂–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Ä—è–¥–æ–º. –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –∏ —É–¥–æ–±–Ω—ã–π –∑–∞–∫–∞–∑.' %}{% endblock %}">
  <meta name="twitter:image" content="{% block tw_image %}https://mezon-market.uz{% static 'img/logo.jpg' %}{% endblock %}">

  {# Tailwind + —Ç–≤–æ–π CSS #}
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'css/site.css' %}">
</head>

<body class="min-h-screen text-white">

<!-- ================= HEADER ================= -->
<header id="siteHeader"
        class="sticky top-0 z-50 bg-sky-700/90 backdrop-blur border-b border-white/15
               transition-transform duration-300 will-change-transform">
  <div class="max-w-6xl mx-auto px-3 sm:px-4 py-2 sm:py-3 flex items-center justify-between gap-2">

    <!-- LOGO (–∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –Ω–∞ –º–æ–±–∏–ª–µ) -->
    <a href="{% url 'home' %}" class="flex items-center gap-2 min-w-0">
      <img src="{% static 'img/logo.jpg' %}"
           alt="{% trans 'MEZON Market' %}"
           class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl object-cover border border-white/20">
      <div class="min-w-0 leading-tight">
        <div class="font-extrabold truncate text-sm sm:text-base">{% trans "MEZON Market" %}</div>
        <div class="text-[11px] sm:text-xs text-white/60 truncate">{% trans "–°–≤–µ–∂–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Ä—è–¥–æ–º" %}</div>
      </div>
    </a>

    <!-- NAV: –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–Ω—ã ‚Äî –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É -->
    <nav class="flex flex-wrap justify-end items-center gap-1.5 sm:gap-2 text-[13px] sm:text-base max-w-[70%]">
      <a href="{% url 'home' %}"
         class="px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-xl hover:bg-white/10 transition">
        {% trans "–ö–∞—Ç–∞–ª–æ–≥" %}
      </a>

      <a href="{% url 'track_order' %}"
         class="px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-xl hover:bg-white/10 transition">
        {% trans "–ú–æ–π –∑–∞–∫–∞–∑" %}
      </a>

      <a href="{% url 'cart' %}"
         class="px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-xl hover:bg-white/10 transition flex items-center gap-2">
        {% trans "–ö–æ—Ä–∑–∏–Ω–∞" %}
        <span class="min-w-6 h-6 px-2 rounded-full text-xs bg-white/10 border border-white/20 flex items-center justify-center">
          <span id="cartCount">{{ cart_count|default:0 }}</span>
        </span>
      </a>

      <!-- THEME -->
      <button id="themeBtn" type="button"
              aria-label="{% trans '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É' %}"
              class="px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-xl
                     bg-white/20 border border-white/30 hover:bg-white/30 transition
                     flex items-center justify-center text-white">
        <span id="themeIcon" class="inline-flex w-5 h-5"></span>
      </button>

      <!-- LANGUAGE -->
      <div class="relative">
        <button id="langBtn" type="button"
                aria-label="{% trans '–í—ã–±–æ—Ä —è–∑—ã–∫–∞' %}"
                aria-haspopup="true"
                aria-expanded="false"
                class="px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-xl
                       bg-white/20 border border-white/30 hover:bg-white/30 transition
                       text-white flex items-center gap-2">
          üåê {{ LANGUAGE_CODE|upper }}
          <svg id="langArrow" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
          </svg>
        </button>

        {# –í–ê–ñ–ù–û: –±–µ–∑ hidden (–∏–Ω–∞—á–µ –Ω–µ –∞–Ω–∏–º–∏—Ä—É–µ—Ç—Å—è) #}
        <div id="langMenu"
     class="absolute right-0 mt-2 w-44 rounded-xl !bg-white !text-slate-900
            border border-sky-300 shadow-xl overflow-hidden z-50
            opacity-0 translate-y-2 scale-95 pointer-events-none
            transition-all duration-200 ease-out">
            <form action="{% url 'set_language' %}" method="post" class="!bg-white !text-slate-900">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">

              <button type="submit" name="language" value="ru"
                      class="w-full px-4 py-2 hover:bg-sky-100 transition text-left whitespace-nowrap !text-slate-900">
                üá∑üá∫ –†—É—Å—Å–∫–∏–π
              </button>

              <button type="submit" name="language" value="uz"
                      class="w-full px-4 py-2 hover:bg-sky-100 transition text-left whitespace-nowrap !text-slate-900">
                üá∫üáø –é–∑–±–µ–∫—á–∞
              </button>

              <button type="submit" name="language" value="uz-latn"
                      class="w-full px-4 py-2 hover:bg-sky-100 transition text-left whitespace-nowrap !text-slate-900">
                üá∫üáø O ªzbekcha
              </button>
            </form>
          </div>

            </button>
          </form>
        </div>
      </div>
    </nav>
  </div>
</header>

<!-- ================= HERO ================= -->
<section class="max-w-6xl mx-auto px-4 pt-4 sm:pt-5">
  {% block hero %}{% endblock %}
</section>

<!-- ================= CONTENT ================= -->
<main class="max-w-6xl mx-auto px-4 pt-5 pb-[calc(6rem+env(safe-area-inset-bottom))]">
  {% block content %}{% endblock %}
</main>

<!-- ================= FOOTER ================= -->
<footer class="border-t border-white/10">
  <div class="max-w-6xl mx-auto px-4 py-6 text-sm text-white/60 flex flex-col sm:flex-row justify-between gap-2">
    <div>¬© {{ now|date:"Y" }} MEZON Market</div>
    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
      <span>{% trans "–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞" %}:</span>
      <a href="tel:+998942910023" class="text-white underline hover:text-white/80 transition">
        +998 94 291-00-23
      </a>
      <span class="hidden sm:inline text-white/40">‚Ä¢</span>
      <a href="https://t.me/mezonmarketuz" target="_blank" rel="noopener"
         class="text-white underline hover:text-white/80 transition flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4" aria-hidden="true">
          <path d="M9.036 15.454 8.8 19.07c.341 0 .488-.146.665-.32l1.596-1.52 3.306 2.42c.607.336 1.04.159 1.197-.562l2.168-10.19c.21-.97-.35-1.35-.94-1.12L3.11 10.05c-.92.36-.91.86-.17 1.09l3.46 1.08 8.03-5.07c.38-.23.73-.11.44.14"/>
        </svg>
        @MEZON_support
      </a>
    </div>
  </div>
</footer>

<!-- ================= TOAST (–æ–¥–∏–Ω) ================= -->
<div id="toast"
     class="fixed left-1/2 -translate-x-1/2 bottom-6 z-50 w-[calc(100%-24px)] max-w-md
            pointer-events-none opacity-0 translate-y-3 transition duration-300
            rounded-2xl px-4 py-3 text-sm bg-black/85 border border-white/10 shadow-lg backdrop-blur">
  <span id="toastText"></span>
</div>

<!-- ================= JS ================= -->
<script>
  (function () {
    const btn = document.getElementById("langBtn");
    const menu = document.getElementById("langMenu"); // –í–ê–ñ–ù–û: langMenu
    const arrow = document.getElementById("langArrow");
    if (!btn || !menu) return;

    function openMenu() {
      btn.setAttribute("aria-expanded", "true");
      menu.classList.remove("opacity-0", "translate-y-2", "scale-95", "pointer-events-none");
      menu.classList.add("opacity-100", "translate-y-0", "scale-100");
      if (arrow) arrow.classList.add("rotate-180");
    }

    function closeMenu() {
      btn.setAttribute("aria-expanded", "false");
      menu.classList.add("opacity-0", "translate-y-2", "scale-95", "pointer-events-none");
      menu.classList.remove("opacity-100", "translate-y-0", "scale-100");
      if (arrow) arrow.classList.remove("rotate-180");
    }

    btn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      const isOpen = btn.getAttribute("aria-expanded") === "true";
      isOpen ? closeMenu() : openMenu();
    });

    menu.addEventListener("click", (e) => e.stopPropagation());
    document.addEventListener("click", closeMenu);
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeMenu(); });
    window.addEventListener("scroll", closeMenu, { passive: true });
  })();

  // ===== Theme toggle (dark/light) =====
  (function () {
    const STORAGE_KEY = "theme";
    const root = document.documentElement;
    const btn = document.getElementById("themeBtn");
    const icon = document.getElementById("themeIcon");
    if (!btn || !icon) return;

    function setIcon(theme){
  if (theme === "light") {
    // –°–û–õ–ù–¶–ï
    icon.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg"
           viewBox="0 0 24 24"
           fill="none"
           stroke="white"
           stroke-width="2"
           stroke-linecap="round"
           stroke-linejoin="round"
           class="w-5 h-5">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>`;
  } else {
    // –õ–£–ù–ê
    icon.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg"
           viewBox="0 0 24 24"
           fill="none"
           stroke="white"
           stroke-width="2"
           stroke-linecap="round"
           stroke-linejoin="round"
           class="w-5 h-5">
        <path d="M21 12.79A9 9 0 1 1 11.21 3
                 7 7 0 0 0 21 12.79z"/>
      </svg>`;
  }
}


    function applyTheme(theme){
      root.setAttribute("data-theme", theme);
      setIcon(theme);
    }

    const saved = localStorage.getItem(STORAGE_KEY);
    const initial = saved || "dark";
    applyTheme(initial);

    btn.addEventListener("click", () => {
      const next = (root.getAttribute("data-theme") === "light") ? "dark" : "light";
      localStorage.setItem(STORAGE_KEY, next);
      applyTheme(next);
    });
  })();


  // ===== Toast (success/error) =====
  const toastEl = document.getElementById("toast");
  const toastTextEl = document.getElementById("toastText");
  let toastTimer = null;

  function showToast(text, type = "success") {
    if (!toastEl || !toastTextEl) return;

    toastTextEl.textContent = text;

    // –æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏
    toastEl.classList.remove(
      "bg-black/85", "border-white/10", "text-white",
      "bg-green-500/20", "border-green-400/30", "text-green-100",
      "bg-red-500/20", "border-red-400/30", "text-red-100"
    );

    if (type === "error") {
      toastEl.classList.add("bg-red-500/20", "border-red-400/30", "text-red-100");
    } else {
      toastEl.classList.add("bg-green-500/20", "border-green-400/30", "text-green-100");
    }

    toastEl.classList.remove("opacity-0", "translate-y-3");
    toastEl.classList.add("opacity-100", "translate-y-0");

    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      toastEl.classList.add("opacity-0", "translate-y-3");
      toastEl.classList.remove("opacity-100", "translate-y-0");
    }, 1600);
  }

  // ===== CSRF helper =====
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  function setCartCount(n) {
    const el = document.getElementById("cartCount");
    if (el) el.textContent = String(n ?? 0);
  }

  // ===== Add to cart =====
  async function addToCart(btn) {
    const url = btn.dataset.url;
    const name = btn.dataset.name || "–¢–æ–≤–∞—Ä";
    const csrftoken =
      getCookie("csrftoken") ||
      document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

    if (!url) {
      showToast("–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω URL –¥–æ–±–∞–≤–ª–µ–Ω–∏—è", "error");
      return;
    }

    btn.disabled = true;
    btn.classList.add("opacity-70");

    try {
      const res = await fetch(url, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "X-CSRFToken": csrftoken || "",
          "X-Requested-With": "XMLHttpRequest",
          "Accept": "application/json",
        },
      });

      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (!ct.includes("application/json")) {
        const text = await res.text();
        showToast(`–û—à–∏–±–∫–∞ ${res.status}`, "error");
        console.warn("Non-JSON response:", text);
        return;
      }

      const data = await res.json();

      if (res.ok && data && data.ok) {
        showToast(`${name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É`, "success");
        if (typeof data.cart_count !== "undefined") setCartCount(data.cart_count);
      } else {
        showToast((data && data.error) ? data.error : "–û—à–∏–±–∫–∞", "error");
      }
    } catch (e) {
      showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
    } finally {
      btn.disabled = false;
      btn.classList.remove("opacity-70");
    }
  }

  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-add-to-cart]");
    if (!btn) return;
    e.preventDefault();
    if (btn.disabled) return;
    addToCart(btn);
  });
    // ===== Header hide on scroll down / show on scroll up =====
  (function () {
    const header = document.getElementById("siteHeader");
    if (!header) return;

    let lastY = window.scrollY || 0;
    let ticking = false;

    function onScroll() {
      const y = window.scrollY || 0;
      const goingDown = y > lastY;
      const pastThreshold = y > 80;

      if (goingDown && pastThreshold) header.classList.add("-translate-y-full");
      else header.classList.remove("-translate-y-full");

      lastY = y;
      ticking = false;
    }

    window.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(onScroll);
        ticking = true;
      }
    }, { passive: true });
  })();

</script>

</body>
</html>
