{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Оформление заказа" %} — {% trans "MEZON Market" %}{% endblock %}

{% block content %}
<div class="mt-6 max-w-xl mx-auto">
  <h1 class="text-2xl font-extrabold mb-4">{% trans "Оформление заказа" %}</h1>

  <div class="glass p-6">
    {% if error %}
      <div class="mb-3 text-red-400">{{ error }}</div>
    {% endif %}

    {% if has_oos %}
      <div class="mb-3 text-red-400">
        {% trans "Некоторые товары в корзине закончились. Вернитесь в корзину и удалите их, затем попробуйте снова." %}
      </div>
    {% endif %}

    <form method="post" class="space-y-3">
      {% csrf_token %}

      <input
        name="name"
        autocomplete="name"
        required
        placeholder="{% trans 'Ваше имя' %}"
        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/15"
      >

      <input
        name="phone"
        type="tel"
        inputmode="tel"
        autocomplete="tel"
        required
        placeholder="{% trans 'Телефон' %}"
        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/15"
      >

      <input
        name="address"
        id="id_address"
        autocomplete="street-address"
        required
        placeholder="{% trans 'Адрес доставки' %}"
        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/15"
      >

      <textarea
        name="comment"
        rows="3"
        placeholder="{% trans 'Комментарий (необязательно)' %}"
        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/15"
      ></textarea>

      <!-- Гео скрытые поля -->
      <input type="hidden" name="lat" id="lat">
      <input type="hidden" name="lng" id="lng">

      <div class="space-y-2">
        <button type="button" id="geoBtn" class="btn-brand" aria-describedby="geoStatus">
          {% trans "Определить местоположение" %}
        </button>

        <div id="geoStatus" class="text-sm text-white/70"></div>
      </div>

      <div class="text-white/70 text-sm">
        {% trans "Доставка" %}: <b>{{ delivery_fee }} {% trans "сум" %}</b>
      </div>

      {% if has_oos %}
        <button class="btn-brand w-full text-lg opacity-60 cursor-not-allowed" disabled>
          {% trans "Оформить заказ" %}
        </button>
        <div class="text-white/60 text-xs">
          {% trans "Сначала удалите отсутствующие товары из корзины." %}
        </div>
      {% else %}
        <button class="btn-brand w-full text-lg">
          {% trans "Оформить заказ" %}
        </button>
      {% endif %}
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("geoBtn");
  const statusEl = document.getElementById("geoStatus");
  const addressInput = document.getElementById("id_address");
  const latEl = document.getElementById("lat");
  const lngEl = document.getElementById("lng");

  if (!btn) return;

  btn.addEventListener("click", () => {
    if (!navigator.geolocation) {
      if (statusEl) statusEl.textContent = "{% trans 'Геолокация не поддерживается браузером.' %}";
      return;
    }

    if (statusEl) statusEl.textContent = "{% trans 'Запрашиваем геолокацию...' %}";

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if (latEl) latEl.value = lat;
        if (lngEl) lngEl.value = lng;

        // Минимум: пишем координаты в адрес (дальше можно заменить на реальный адрес через API)
        if (addressInput) addressInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

        if (statusEl) statusEl.textContent = "{% trans '✅ Местоположение получено' %}";
      },
      (err) => {
        let msg = "{% trans 'Не удалось получить геолокацию (разрешите доступ).' %}";
        if (err.code === 1) msg = "{% trans 'Доступ к геолокации запрещён (разрешите доступ).' %}";
        if (err.code === 2) msg = "{% trans 'Геолокация недоступна (нет сети/сигнала).' %}";
        if (err.code === 3) msg = "{% trans 'Истекло время ожидания геолокации.' %}";
        if (statusEl) statusEl.textContent = msg;
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  });
});
</script>
{% endblock %}
