{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Оформление заказа" %} — {% trans "MEZON Market" %}{% endblock %}

{% block content %}
<div class="mt-6 max-w-xl mx-auto">
  <h1 class="text-2xl font-extrabold mb-4">{% trans "Оформление заказа" %}</h1>

  <div class="glass p-6">
    {% if error %}
      <div class="mb-3 text-red-400">{{ error }}</div>
    {% endif %}

{% if has_oos %}
  <div class="mb-3 text-red-400">
    {% trans "Некоторые товары в корзине закончились. Вернитесь в корзину и удалите их, затем попробуйте снова." %}
  </div>
{% endif %}


    <form method="post" class="space-y-3">
      {% csrf_token %}

      <input name="name" placeholder="{% trans 'Ваше имя' %}"
             class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/15">

      <input name="phone" placeholder="{% trans 'Телефон' %}"
             class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/15">

      <input name="address" placeholder="{% trans 'Адрес доставки' %}"
             class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/15">

      <input name="comment" placeholder="{% trans 'Комментарий (необязательно)' %}"
             class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/15">

      <!-- Гео скрытые поля -->
      <input type="hidden" name="lat" id="lat">
      <input type="hidden" name="lng" id="lng">

      <div class="space-y-2">
        <button type="button" class="btn-brand w-full" id="geoBtn">
          {% trans "Определить местоположение" %}
        </button>
        <div id="geoStatus" class="text-white/70 text-sm"></div>
      </div>

      <div class="text-white/70 text-sm">
        {% trans "Доставка" %}: <b>{{ delivery_fee }} {% trans "сум" %}</b>
      </div>

      {% if has_oos %}
      <button class="btn-brand w-full text-lg opacity-60 cursor-not-allowed" disabled>
        {% trans "Оформить заказ" %}
      </button>
      <div class="text-white/60 text-xs mt-2">
        {% trans "Сначала удалите отсутствующие товары из корзины." %}
      </div>
    {% else %}
      <button class="btn-brand w-full text-lg">
        {% trans "Оформить заказ" %}
      </button>
    {% endif %}
    </form>
  </div>
</div>

<script>
  const T_GEO_REQUEST = "{% trans 'Запрашиваем геолокацию...' %}";
  const T_GEO_NOT_SUPPORTED = "{% trans 'Геолокация не поддерживается браузером.' %}";
  const T_GEO_OK = "{% trans '✅ Местоположение получено' %}";
  const T_GEO_FAIL = "{% trans 'Не удалось получить геолокацию (разрешите доступ).' %}";

  document.getElementById("geoBtn").onclick = () => {
    const geoStatus = document.getElementById("geoStatus");
    geoStatus.textContent = T_GEO_REQUEST;

    if (!navigator.geolocation) {
      geoStatus.textContent = T_GEO_NOT_SUPPORTED;
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        document.getElementById("lat").value = pos.coords.latitude;
        document.getElementById("lng").value = pos.coords.longitude;
        geoStatus.textContent = T_GEO_OK;
      },
      () => {
        geoStatus.textContent = T_GEO_FAIL;
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  };
</script>
{% endblock %}
