{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞" %} ‚Äî {% trans "MEZON Market" %}{% endblock %}

{% block content %}
<div class="mt-6 max-w-xl mx-auto">
  <h1 class="text-2xl font-extrabold mb-4">{% trans "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞" %}</h1>

  <div class="glass p-5 sm:p-6 rounded-3xl">
    {% if error %}
      <div class="mb-3 text-red-300 bg-red-500/10 border border-red-400/30 rounded-2xl p-3">
        {{ error }}
      </div>
    {% endif %}

    {% if has_oos %}
      <div class="mb-3 text-red-300 bg-red-500/10 border border-red-400/30 rounded-2xl p-3">
        {% trans "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–∑–∏–Ω—É –∏ —É–¥–∞–ª–∏—Ç–µ –∏—Ö, –∑–∞—Ç–µ–º –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞." %}
      </div>
    {% endif %}

    <form method="post" class="space-y-3">
      {% csrf_token %}

      <input name="name" autocomplete="name" required
             placeholder="{% trans '–í–∞—à–µ –∏–º—è' %}"
             class="w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 outline-none">

      <input name="phone" type="tel" inputmode="tel" autocomplete="tel" required
             placeholder="{% trans '–¢–µ–ª–µ—Ñ–æ–Ω' %}"
             class="w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 outline-none">

      <input name="address" id="id_address" autocomplete="street-address" required
             placeholder="{% trans '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏' %}"
             class="w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 outline-none">

      <textarea name="comment" rows="3"
                placeholder="{% trans '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)' %}"
                class="w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 outline-none"></textarea>

    <!-- –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
<div class="space-y-1">
  <span class="text-sm text-gray-700 dark:text-gray-300">{% trans "–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã" %}</span>
  <div class="flex gap-3 mt-2">
    <!-- –ù–∞–ª–∏—á–Ω—ã–µ -->
    <label class="flex-1">
      <input type="radio" name="payment_method" value="cash" checked class="sr-only peer">
      <div
        class="cursor-pointer rounded-2xl border border-gray-300 dark:border-gray-600
               bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 py-3 text-center font-medium
               transition-all duration-200
               peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">
        {% trans "–ù–∞–ª–∏—á–Ω—ã–µ" %}
      </div>
    </label>

    <!-- –ö–∞—Ä—Ç–æ–π -->
    <label class="flex-1">
      <input type="radio" name="payment_method" value="card" class="sr-only peer">
      <div
        class="cursor-pointer rounded-2xl border border-gray-300 dark:border-gray-600
               bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 py-3 text-center font-medium
               transition-all duration-200
               peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">
        {% trans "–ö–∞—Ä—Ç–æ–π" %}
      </div>
    </label>
  </div>
</div>


      <!-- –ì–µ–æ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è -->
      <input type="hidden" name="lat" id="lat">
      <input type="hidden" name="lng" id="lng">

      <div class="space-y-2">
        <button type="button" id="geoBtn" class="btn-brand w-full" aria-describedby="geoStatus">
          {% trans "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" %}
        </button>
        <div id="geoStatus" class="text-sm text-white/70"></div>
      </div>

      <div class="text-white/70 text-sm space-y-1 pt-1">
        <div>{% trans "–î–æ—Å—Ç–∞–≤–∫–∞" %}: <b>{{ delivery_fee }} {% trans "—Å—É–º" %}</b></div>
        <div>‚è∞ {% trans "–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏" %}: <b>10:00‚Äì22:00</b></div>
        <div>üßæ {% trans "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞" %}: <b>50 000</b> {% trans "—Å—É–º" %}</div>
      </div>

      {% if has_oos %}
        <button class="btn-brand w-full text-lg opacity-60 cursor-not-allowed" disabled>
          {% trans "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑" %}
        </button>
        <div class="text-white/60 text-xs">{% trans "–°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã." %}</div>
      {% else %}
        <button class="btn-brand w-full text-lg">
          {% trans "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑" %}
        </button>
      {% endif %}
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("geoBtn");
  const statusEl = document.getElementById("geoStatus");
  const addressInput = document.getElementById("id_address");
  const latEl = document.getElementById("lat");
  const lngEl = document.getElementById("lng");
  if (!btn) return;

  btn.addEventListener("click", () => {
    if (!navigator.geolocation) {
      if (statusEl) statusEl.textContent = "{% trans '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º.' %}";
      return;
    }

    if (statusEl) statusEl.textContent = "{% trans '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é...' %}";

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        if (latEl) latEl.value = lat;
        if (lngEl) lngEl.value = lng;
        if (addressInput) addressInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        if (statusEl) statusEl.textContent = "{% trans '‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ' %}";
      },
      (err) => {
        let msg = "{% trans '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é (—Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø).' %}";
        if (err.code === 1) msg = "{% trans '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω (—Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø).' %}";
        if (err.code === 2) msg = "{% trans '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–Ω–µ—Ç —Å–µ—Ç–∏/—Å–∏–≥–Ω–∞–ª–∞).' %}";
        if (err.code === 3) msg = "{% trans '–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.' %}";
        if (statusEl) statusEl.textContent = msg;
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  });
});
</script>
{% endblock %}
