{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Заказ" %} №{{ order.id }} — {% trans "MEZON Market" %}{% endblock %}

{% block content %}
<div class="mt-6 max-w-2xl mx-auto">
  <div class="glass p-6">

    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="text-2xl font-extrabold">{% trans "Заказ" %} №{{ order.id }}</div>

        <div class="text-white/70 text-sm mt-1">
          {% trans "Статус" %}:
          <b>
            {% if order.status == "new" %}
              {% trans "Новый" %}
            {% elif order.status == "canceled" %}
              {% trans "Отменен" %}
            {% elif order.status == "done" %}
              {% trans "Выполнен" %}
            {% else %}
              {{ order.status }}
            {% endif %}
          </b>
        </div>
      </div>

      <a href="{% url 'track_order' %}" class="badge-soft px-4 py-2 rounded-2xl">
        ← {% trans "Найти другой" %}
      </a>
    </div>

    {# ✅ ВАЖНО: показываем "Заказ отменен" после отмены #}
    {% if order.status == "canceled" %}
      <div class="mt-4 glass p-3 text-green-300">
        {% trans "Заказ отменен" %}
      </div>
    {% endif %}

    <div class="mt-5 space-y-3">
      {% for row in rows %}
        <div class="flex justify-between items-center gap-3">
          <div class="min-w-0">
            <div class="font-bold truncate">{{ row.it.product.name }}</div>
            <div class="text-white/60 text-sm">
              {{ row.it.qty }} × {{ row.it.price_at_time }} {% trans "сум" %}
            </div>
          </div>
          <div class="price whitespace-nowrap">
            {{ row.line }} {% trans "сум" %}
          </div>
        </div>
      {% empty %}
        <div class="text-white/60">{% trans "Товары не найдены." %}</div>
      {% endfor %}
    </div>

    <hr class="border-white/10 my-5">

    <div class="flex justify-between text-white/70">
      <span>{% trans "Доставка" %}</span>
      <span>{{ delivery_fee }} {% trans "сум" %}</span>
    </div>

    <div class="flex justify-between text-xl font-extrabold mt-2">
      <span>{% trans "Итого" %}</span>
      <span>{{ order.total }} {% trans "сум" %}</span>
    </div>

    {# ✅ Кнопка отмены только для new #}
    {% if order.status == "new" %}
      <form method="post" action="{% url 'cancel_order_token' order.public_token %}" class="mt-5">
        {% csrf_token %}
        <button class="w-full px-4 py-3 rounded-2xl border border-red-400/40 text-red-200 hover:bg-red-500/10 transition">
          {% trans "Отменить заказ" %}
        </button>
      </form>
      <div class="text-white/60 text-xs mt-2">
        {% trans "Отмена возможна только пока заказ новый." %}
      </div>

    {% else %}
      {# если canceled — уже показали зеленое сообщение и НЕ надо писать "нельзя отменить" #}
      {% if order.status != "canceled" %}
        <div class="mt-5 text-white/60 text-sm">
          {% trans "Этот заказ уже нельзя отменить." %}
        </div>
      {% endif %}
    {% endif %}

  </div>
</div>
{% endblock %}
